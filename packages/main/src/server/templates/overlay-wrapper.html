<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Overlay Wrapper - {{TITLE}}</title>
  <style>
    html, body, #app { height: 100%; margin: 0; padding: 0; }
    #app { display: flex; }
    iframe { width: 100%; height: 100%; border: 0; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    (function(){
      var pluginId = {{PLUGIN_ID_JSON}};
      var overlayId = {{OVERLAY_ID_JSON}};
      var childSrc = {{PLUGIN_URL_JSON}};
      var appEl = document.getElementById('app');
      if (!appEl) return;

      window.__WUJIE_SHARED = window.__WUJIE_SHARED || {};
      window.__WUJIE_SHARED.readonlyStore = {};

      var iframe = document.createElement('iframe');
      iframe.name = 'overlay:' + overlayId;
      iframe.src = childSrc;
      iframe.referrerPolicy = 'no-referrer';
      iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';
      appEl.appendChild(iframe);

      var __API_BASE_OVERRIDE = null;
      var __propsInjectedFor = null;

      function injectProps(){
        try {
          var win = iframe.contentWindow;
          if (!win) return;
          if (__propsInjectedFor && String(__propsInjectedFor) === String(overlayId)) { return; }
          win.__WUJIE_PROPS__ = win.__WUJIE_PROPS__ || {};
          win.__WUJIE_PROPS__.overlayId = overlayId;
          win.__WUJIE_PROPS__.shared = { readonlyStore: window.__WUJIE_SHARED.readonlyStore };
          __propsInjectedFor = overlayId;
          try { console.log('[overlay-wrapper] injectProps', { pluginId: pluginId, overlayId: overlayId }); } catch(e){}
        } catch (e) { console.warn('[overlay-wrapper] props injection failed:', e); }
      }

      iframe.addEventListener('load', function(){
        injectProps();
        try { postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-lifecycle', payload: { phase: 'wrapped-init' } }); } catch(e){}
        try { console.log('[overlay-wrapper] iframe loaded'); } catch(e){}
      });

      function postToChild(payload){
        try {
          var win = iframe.contentWindow;
          if (!win) return;
          win.postMessage(payload, '*');
        } catch (e) { console.warn('[overlay-wrapper] postMessage failed:', e); }
      }

      var __ES_STORE = null;
      function subscribeReadonlyStore(){
        try {
          var base = __API_BASE_OVERRIDE || (window.location && window.location.origin) || '';
          var bstr = String(base);
          var joinBase = bstr.charAt(bstr.length - 1) === '/' ? bstr.slice(0, -1) : bstr;
          var es = new EventSource(joinBase + '/sse/renderer/readonly-store');
          __ES_STORE = es;
          es.onopen = function(){ try { console.log('[overlay-wrapper] SSE(open) readonly-store'); } catch(e){} };
          es.addEventListener('readonly-store-init', function(ev){
            try {
              var data = JSON.parse(ev.data || '{}');
              window.__WUJIE_SHARED.readonlyStore = window.__WUJIE_SHARED.readonlyStore || {};
              for (var k in data){ try { window.__WUJIE_SHARED.readonlyStore[k] = data[k]; } catch(_e){} }
              postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'readonly-store-init', payload: data });
              try { console.log('[overlay-wrapper] SSE store init'); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] store init parse failed:', e); }
          });
          es.addEventListener('readonly-store-update', function(ev){
            try {
              var data = JSON.parse(ev.data || '{}');
              window.__WUJIE_SHARED.readonlyStore = window.__WUJIE_SHARED.readonlyStore || {};
              for (var k in data){ try { window.__WUJIE_SHARED.readonlyStore[k] = Object.assign({}, window.__WUJIE_SHARED.readonlyStore[k] || {}, data[k]); } catch(_e){} }
              postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'readonly-store-update', payload: data });
              try { console.log('[overlay-wrapper] SSE store update'); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] store update parse failed:', e); }
          });
          es.addEventListener('heartbeat', function(ev){ try { console.log('[overlay-wrapper] SSE heartbeat(store)', ev && ev.data); } catch(e){} });
          es.onerror = function(){ try { console.warn('[overlay-wrapper] SSE(store) error, reconnecting...'); } catch(e){} try { es.close(); } catch(e){} setTimeout(subscribeReadonlyStore, 3000); };
        } catch(e){ console.warn('[overlay-wrapper] SSE store init failed:', e); }
      }

      function ensureOverlay(){
        return new Promise(function(resolve){
          if (overlayId) { resolve(overlayId); return; }
          try {
            fetch('/api/overlay/create', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ pluginId: pluginId, type: 'default' })
            }).then(function(resp){ return resp.json(); }).then(function(json){
              if (json && json.success && json.overlayId) {
                overlayId = String(json.overlayId);
                try { iframe.name = 'overlay:' + overlayId; } catch(e){}
                injectProps();
                subscribeReadonlyStore();
                try { postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-lifecycle', payload: { phase: 'auto-created' } }); } catch(e){}
                try { console.log('[overlay-wrapper] auto-created overlay', { overlayId: overlayId }); } catch(e){}
              } else {
                console.warn('[overlay-wrapper] auto create overlay failed:', json);
              }
              resolve(overlayId || null);
            }).catch(function(e){ console.warn('[overlay-wrapper] auto create overlay error:', e); resolve(null); });
          } catch(e){ console.warn('[overlay-wrapper] auto create overlay error:', e); resolve(null); }
        });
      }

      try {
        var lastEventId = null;
        var seenIds = new Set();
        var pluginStreamActive = false;
        var __ES_PLUGIN = null;
        var __ES_OVERLAY = null;
        var __autoRecreateAttempts = 0;
        var __recreateInFlight = false;
        var __lastUpdateStamp = null;
        function __shouldForwardUpdate(ov){
          try {
            var ts = String((ov && ov.updatedAt) || '');
            var stamp = String(overlayId) + '|' + ts;
            if (__lastUpdateStamp && __lastUpdateStamp === stamp) return false;
            __lastUpdateStamp = stamp; return true;
          } catch(e){ return true; }
        }

        function autoRecreateOverlay(){
          if (__recreateInFlight) return;
          __recreateInFlight = true;
          __autoRecreateAttempts++;
          if (__autoRecreateAttempts > 3) { try { console.warn('[overlay-wrapper] auto recreate max attempts reached'); } catch(e){} __recreateInFlight = false; return; }
          try {
            fetch('/api/overlay/create', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ pluginId: pluginId, type: 'default' })
            }).then(function(resp){ return resp.json(); }).then(function(json){
              try {
                if (json && json.success && json.overlayId) {
                  overlayId = String(json.overlayId);
                  try { iframe.name = 'overlay:' + overlayId; } catch(e){}
                  __propsInjectedFor = null;
                  injectProps();
                  try { if (__ES_PLUGIN) __ES_PLUGIN.close(); } catch(e){}
                  connect();
                  try { console.log('[overlay-wrapper] auto recreated overlay', { overlayId: overlayId }); } catch(e){}
                } else {
                  console.warn('[overlay-wrapper] auto recreate failed:', json);
                }
              } finally { __recreateInFlight = false; }
            }).catch(function(e){ console.warn('[overlay-wrapper] auto recreate error:', e); __recreateInFlight = false; });
          } catch(e){ console.warn('[overlay-wrapper] auto recreate exception:', e); __recreateInFlight = false; }
        }
        function subscribeOverlayChannel(){
          if (!overlayId) return;
          try {
            var base = __API_BASE_OVERRIDE || (window.location && window.location.origin) || '';
            var bstr = String(base);
            var joinBase = bstr.charAt(bstr.length - 1) === '/' ? bstr.slice(0, -1) : bstr;
            var es = new EventSource(joinBase + '/sse/overlay/' + encodeURIComponent(String(overlayId)));
            __ES_OVERLAY = es;
            try { console.log('[overlay-wrapper] SSE connect overlay channel', { overlayId: overlayId }); } catch(e){}
            es.addEventListener('init', function(ev){
              try {
                var data = JSON.parse(ev.data || '{}');
                var ov = data && data.overlay || null;
                if (ov) {
                  window.__WUJIE_SHARED.readonlyStore.overlay = ov || {};
                  postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-updated', payload: { overlay: ov } });
                }
              } catch(e){ console.warn('[overlay-wrapper] overlay init parse failed:', e); }
            });
            es.addEventListener('update', function(ev){
              try {
                var rec = JSON.parse(ev.data || '{}');
                var ov = rec && rec.overlay || null;
                if (ov) {
                  if (!__shouldForwardUpdate(ov)) return;
                  window.__WUJIE_SHARED.readonlyStore.overlay = ov;
                  postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-updated', payload: { overlay: ov } });
                }
              } catch(e){ console.warn('[overlay-wrapper] overlay update parse failed:', e); }
            });
            es.addEventListener('message', function(ev){
              try {
                var rec = JSON.parse(ev.data || '{}');
                var msg = (rec && rec.payload) || rec;
                postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: String(msg && msg.event || ''), payload: msg && msg.payload });
              } catch(e){ console.warn('[overlay-wrapper] overlay message parse failed:', e); }
            });
            es.addEventListener('closed', function(){
              postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-closed' });
            });
            es.addEventListener('heartbeat', function(ev){ try { console.log('[overlay-wrapper] SSE heartbeat(overlay)', ev && ev.data); } catch(e){} });
            es.onerror = function(){ try { console.warn('[overlay-wrapper] SSE(overlay) error, reconnecting...'); } catch(e){} try { es.close(); } catch(e){} setTimeout(subscribeOverlayChannel, 3000); };
          } catch(e){ console.warn('[overlay-wrapper] SSE overlay init failed:', e); }
        }

        function connect(){
          var q = lastEventId ? ('?lastEventId=' + encodeURIComponent(lastEventId)) : '';
          var base = __API_BASE_OVERRIDE || (window.location && window.location.origin) || '';
          var bstr = String(base);
          var joinBase = bstr.charAt(bstr.length - 1) === '/' ? bstr.slice(0, -1) : bstr;
          var es = new EventSource(joinBase + '/sse/plugins/' + encodeURIComponent(pluginId) + '/overlay' + q);
          __ES_PLUGIN = es;
          try { console.log('[overlay-wrapper] SSE connect', { pluginId: pluginId, lastEventId: lastEventId }); } catch(e){}
          subscribeReadonlyStore();
          es.onopen = function(){ try { console.log('[overlay-wrapper] SSE(open) plugin channel'); } catch(e){} };
          es.onerror = function(ev){
            try { console.warn('[overlay-wrapper] SSE(plugin) error, enabling overlay fallback'); } catch(e){}
            try { es.close(); } catch(e){}
            // Fallback to overlay-specific SSE when plugin channel is unavailable (disabled/error)
            subscribeOverlayChannel();
            // Also attempt reconnect to plugin channel to recover lifecycle events
            setTimeout(connect, 3000);
          };
          es.addEventListener('init', function(ev){
            try {
              var data = JSON.parse(ev.data || '{}');
              var overlays = Array.isArray(data.overlays) ? data.overlays : [];
              var ov = overlayId ? overlays.find(function(o){ return String(o && o.id) === String(overlayId); }) : null;
              if (ov) {
                window.__WUJIE_SHARED.readonlyStore.overlay = ov || {};
                postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-updated', payload: { overlay: ov } });
              }
              pluginStreamActive = true;
              try { console.log('[overlay-wrapper] SSE init overlays', { count: overlays.length, overlayId: overlayId, found: !!ov }); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] init parse failed:', e); }
          });
          es.addEventListener('update', function(ev){
            try {
              var rec = JSON.parse(ev.data || '{}');
              if (rec && typeof rec.id === 'string') {
                if (seenIds.has(rec.id)) return;
                seenIds.add(rec.id); lastEventId = rec.id;
              }
              var msg = (rec && rec.payload) || rec;
              var ov = {};
              var targetId = '';
              try {
                if (msg && typeof msg === 'object' && (msg.event === 'overlay-updated' || msg.event === 'overlay-update' || typeof msg.overlayId !== 'undefined')) {
                  ov = (msg && msg.payload) || {};
                  targetId = String(msg && msg.overlayId || (ov && ov.id) || '');
                } else {
                  ov = msg || {};
                  targetId = String((ov && ov.id) || '');
                }
              } catch(_e){}
              if (overlayId && String(targetId) !== String(overlayId)) return;
              if (!__shouldForwardUpdate(ov)) { try { console.log('[overlay-wrapper] SSE(update) plugin dedup', { overlayId: overlayId, recId: rec && rec.id, targetId: targetId }); } catch(e){} return; }
              window.__WUJIE_SHARED.readonlyStore.overlay = ov;
              postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-updated', payload: { overlay: ov } });
              pluginStreamActive = true;
              try { console.log('[overlay-wrapper] SSE update', { overlayId: overlayId, recId: rec && rec.id, targetId: targetId }); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] update parse failed:', e); }
          });
          es.addEventListener('lifecycle', function(ev){
            try {
              var rec = JSON.parse(ev.data || '{}');
              if (rec && typeof rec.id === 'string') {
                if (seenIds.has(rec.id)) return;
                seenIds.add(rec.id); lastEventId = rec.id;
              }
              var msg = (rec && rec.payload) || rec;
              postToChild({ type: 'plugin-event', eventType: 'lifecycle', event: String(msg && msg.event || ''), payload: msg && msg.payload });
              pluginStreamActive = true;
              try { console.log('[overlay-wrapper] SSE lifecycle', { event: msg && msg.event }); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] lifecycle parse failed:', e); }
          });
          es.addEventListener('room', function(ev){
            try {
              var rec = JSON.parse(ev.data || '{}');
              if (rec && typeof rec.id === 'string') {
                if (seenIds.has(rec.id)) return;
                seenIds.add(rec.id); lastEventId = rec.id;
              }
              var msg = (rec && rec.payload) || rec;
              postToChild({ type: 'plugin-event', eventType: 'room', event: String(msg && msg.event || ''), payload: msg && msg.payload });
              pluginStreamActive = true;
              try { console.log('[overlay-wrapper] SSE room', { event: msg && msg.event }); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] room parse failed:', e); }
          });
          es.addEventListener('danmaku', function(ev){
            try {
              var rec = JSON.parse(ev.data || '{}');
              if (rec && typeof rec.id === 'string') {
                if (seenIds.has(rec.id)) return;
                seenIds.add(rec.id); lastEventId = rec.id;
              }
              var msg = (rec && rec.payload) || rec;
              postToChild({ type: 'plugin-event', eventType: 'danmaku', event: String(msg && msg.event || ''), payload: msg && msg.payload });
              pluginStreamActive = true;
              try { console.log('[overlay-wrapper] SSE danmaku'); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] danmaku parse failed:', e); }
          });
          es.addEventListener('message', function(ev){
            try {
              var rec = JSON.parse(ev.data || '{}');
              if (rec && typeof rec.id === 'string') {
                if (seenIds.has(rec.id)) return;
                seenIds.add(rec.id); lastEventId = rec.id;
              }
              var msg = (rec && rec.payload) || rec;
              if (overlayId && String(msg && msg.overlayId) !== String(overlayId)) return;
              postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: String(msg && msg.event || ''), payload: msg && msg.payload });
              pluginStreamActive = true;
              try { console.log('[overlay-wrapper] SSE message', { overlayId: overlayId, event: msg && msg.event }); } catch(e){}
            } catch(e){ console.warn('[overlay-wrapper] message parse failed:', e); }
          });
          es.addEventListener('closed', function(ev){
            try {
              var rec = JSON.parse(ev.data || '{}');
              var msg = (rec && rec.payload) || rec;
              if (overlayId && String(msg && msg.overlayId) !== String(overlayId)) return;
              postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-closed' });
              pluginStreamActive = true;
              try { console.log('[overlay-wrapper] SSE closed', { overlayId: overlayId }); } catch(e){}
            } catch(e){ postToChild({ type: 'overlay-event', overlayId: overlayId, eventType: 'overlay-message', event: 'overlay-closed' }); }
          });
          es.addEventListener('heartbeat', function(ev){
            try { pluginStreamActive = true; console.log('[overlay-wrapper] SSE heartbeat(plugin)', ev && ev.data); } catch(e){}
          });
        }
        ensureOverlay().then(function(){
          connect();
          // If overlay channel is critical for UI (e.g., plugin disabled), ensure fallback starts soon
          setTimeout(function(){ if (!pluginStreamActive) subscribeOverlayChannel(); }, 1000);
        });
      } catch(e) { console.warn('[overlay-wrapper] SSE init failed:', e); }

      window.addEventListener('message', function(evt){
        try {
          var msg = evt && evt.data || {};
          if (!msg || typeof msg !== 'object') return;
          var type = msg.type; var id = msg.overlayId;
          if (!type) return;
          if (!overlayId) { console.warn('[overlay-wrapper] overlayId not ready, ignore message:', type); return; }
          if (id !== overlayId) return;
          if (type === 'overlay-action') {
            var action = String(msg.action||'');
            var data = msg.data;
            fetch('/api/overlay/' + encodeURIComponent(overlayId) + '/action', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: action, data: data })
            }).then(function(resp){ try { return resp.json(); } catch(_){ return null; } }).then(function(json){ try { console.log('[overlay-wrapper] forwarded overlay-action', { overlayId: overlayId, action: action, success: json && json.success }); } catch(e){} }).catch(function(e){ console.warn('[overlay-wrapper] forwarded overlay-action error:', e); });
            return;
          }
          if (type === 'overlay-close') {
            fetch('/api/overlay/' + encodeURIComponent(overlayId) + '/action', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'close' })
            }).then(function(resp){ try { return resp.json(); } catch(_){ return null; } }).then(function(json){ try { console.log('[overlay-wrapper] forwarded overlay-close', { overlayId: overlayId, success: json && json.success }); } catch(e){} }).catch(function(e){ console.warn('[overlay-wrapper] forwarded overlay-close error:', e); });
            return;
          }
          if (type === 'overlay-update') {
            var updates = msg.updates;
            fetch('/api/overlay/' + encodeURIComponent(overlayId) + '/action', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'update', data: updates })
            }).then(function(resp){ try { return resp.json(); } catch(_){ return null; } }).then(function(json){ try { console.log('[overlay-wrapper] forwarded overlay-update', { overlayId: overlayId, keys: Object.keys(updates||{}), success: json && json.success }); } catch(e){} }).catch(function(e){ console.warn('[overlay-wrapper] forwarded overlay-update error:', e); });
            return;
          }
          if (type === 'overlay-send') {
            var evName = String(msg.event||'');
            var payload = msg.payload;
            fetch('/api/plugins/' + encodeURIComponent(pluginId) + '/overlay/messages', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ overlayId: overlayId, event: evName, payload: payload })
            }).then(function(resp){ try { return resp.json(); } catch(_){ return null; } }).then(function(json){ try { console.log('[overlay-wrapper] forwarded overlay-send', { overlayId: overlayId, event: evName, success: json && json.success }); } catch(e){} }).catch(function(e){ console.warn('[overlay-wrapper] forwarded overlay-send error:', e); });
            return;
          }
        } catch(e) { console.warn('[overlay-wrapper] message handler error:', e); }
      });
    })();
  </script>
</body>
</html>
