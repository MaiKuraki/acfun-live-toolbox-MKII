<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sample Overlay Window</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container { 
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 4px;
        padding: 6px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        width: 100%;
        height: 100%;
        max-width: 800px;
        max-height: 826px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .header {
        text-align: center;
        margin-bottom: 8px;
        flex-shrink: 0;
        padding: 8px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 4px 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .subtitle {
        font-size: 14px;
        color: #718096;
        margin: 0;
      }
      .content {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }
      .content::-webkit-scrollbar {
        width: 2px;
      }
      .content::-webkit-scrollbar-track {
        background: transparent;
      }
      .content::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 1px;
      }
      .section {
        background: #f8fafc;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        min-height: 80px;
      }
      .section:hover {
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        transform: translateY(-1px);
      }
      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .section-title::before {
        content: '';
        width: 2px;
        height: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 1px;
      }
      .btn { 
        padding: 8px 16px; 
        border: none; 
        border-radius: 6px; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer; 
        font-weight: 500;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .btn-secondary:hover {
        background: #cbd5e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      }
      .row { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        flex-wrap: wrap;
        margin-bottom: 4px;
      }
      .input-group {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 4px;
      }
      .input {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s ease;
        min-width: 150px;
      }
      .input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
      }
      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        background: #e2e8f0;
        color: #4a5568;
      }
      .status-badge.active {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
      }
      .store-container {
        background: #1a202c;
        color: #e2e8f0;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 10px;
        line-height: 1.3;
        max-height: 200px;
        overflow-y: auto;
        border-radius: 3px;
        padding: 8px;
        border: 1px solid #2d3748;
        word-break: break-all;
      }
      .logs-container {
        background: #1a202c;
        color: #68d391;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 10px;
        line-height: 1.3;
        max-height: 150px;
        overflow-y: auto;
        border-radius: 3px;
        padding: 8px;
        border: 1px solid #2d3748;
      }
      @media (max-width: 640px) {
        .container {
          padding: 12px;
          margin: 8px;
        }
        .row {
          flex-direction: column;
          align-items: stretch;
        }
        .input-group {
          flex-direction: column;
        }
        .title {
          font-size: 18px;
        }
        .subtitle {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">Sample Overlay Window</h1>
        <p class="subtitle">现代化的插件界面演示</p>
      </div>
      
      <div class="content">
        <div class="section">
          <h3 class="section-title">交互功能</h3>
          <div class="row">
            <button class="btn" id="btn-toast">显示提示</button>
            <button class="btn" id="btn-alert">显示警告</button>
            <button class="btn" id="btn-confirm">确认对话框</button>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">只读仓库快照</h3>
          <div id="store" class="store-container">{}</div>
        </div>

        <div class="section">
          <h3 class="section-title">主题设置</h3>
          <div class="input-group">
            <input id="bg" type="text" class="input" placeholder="#f4f4f4" />
            <button class="btn btn-secondary" id="btn-save-bg">保存背景色</button>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">运行日志</h3>
          <div id="logs" class="logs-container">等待操作...</div>
        </div>
      </div>
    </div>
    <script>
      var apiBase = String(window.location.origin || 'http://127.0.0.1:18299');
      function parsePluginId(){ try { var m = String(location.pathname||'').match(/\/plugins\/([^\/]+)/); return m && m[1] ? decodeURIComponent(m[1]) : ''; } catch(e){ return ''; } }
      var pluginId = parsePluginId();
      function applyBg(color){ try { document.body.style.background = color || '#f4f4f4'; } catch(e){} }
      var _storeSnap = {};
      function renderStore(data){ try { var el = document.getElementById('store'); if(el){ var formatted = JSON.stringify(data||{}, null, 2); if (formatted.length > 500) { formatted = formatted.substring(0, 500) + '...'; } el.textContent = formatted; } } catch(e){} }
      function logLine(obj){ try { var el = document.getElementById('logs'); if(!el) return; var timestamp = new Date().toLocaleTimeString(); var s = (typeof obj==='string'?obj:JSON.stringify(obj, null, 2)); el.textContent = `[${timestamp}] ${s}\n` + el.textContent; if (el.textContent.split('\n').length > 20) { el.textContent = el.textContent.split('\n').slice(0, 20).join('\n'); } } catch(e){} }
      function fetchSnapshot(keys){ try { return fetch(new URL('/api/renderer/readonly-store/snapshot', apiBase).toString(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ keys: keys||[] }) }).then(function(r){ return r.json(); }).then(function(json){ if(json&&json.success){ _storeSnap = Object.assign({}, _storeSnap, json.data||{}); renderStore(_storeSnap); logLine('只读仓库快照已加载'); } }); } catch(e){ return Promise.resolve(); } }
      function subscribeReadonly(keys){ try { var url = new URL('/sse/renderer/readonly-store/subscribe', apiBase); url.searchParams.set('keys', (keys||[]).join(',')); var src = new EventSource(url.toString()); src.addEventListener('readonly-store-init', function(ev){ try { var data = JSON.parse(ev.data||'{}'); _storeSnap = Object.assign({}, _storeSnap, data||{}); renderStore(_storeSnap); logLine('只读仓库初始化'); } catch(e){} }); src.addEventListener('readonly-store-update', function(ev){ try { var data = JSON.parse(ev.data||'{}'); _storeSnap = Object.assign({}, _storeSnap, data||{}); renderStore(_storeSnap); logLine('只读仓库更新'); } catch(e){} }); src.addEventListener('heartbeat', function(){}); src.onerror = function(){ try { src.close(); } catch(e){} setTimeout(function(){ subscribeReadonly(keys); }, 3000); }; return src; } catch(e){ return null; } }
      function subscribePluginOverlay(){ if(!pluginId) return null; try { var url = new URL('/sse/plugins/'+encodeURIComponent(pluginId)+'/overlay', apiBase); var src = new EventSource(url.toString()); src.addEventListener('init', function(ev){ logLine('overlay:init'); }); src.addEventListener('update', function(ev){ try { var data = JSON.parse(ev.data||'{}'); var ov = (data&&data.payload&&data.payload.overlay)||{}; var style = ov.style||{}; if(style.backgroundColor) applyBg(style.backgroundColor); logLine('overlay:update'); } catch(e){} }); src.addEventListener('message', function(ev){ try { var data = JSON.parse(ev.data||'{}'); var evt = (data&&data.event)||''; var payload = (data&&data.payload)||{}; if(evt==='config-update'){ var color = String(payload.uiBgColor||'').trim(); if(color) applyBg(color); logLine('config-update'); } else { logLine('message:'+evt); } } catch(e){} }); src.addEventListener('action', function(ev){ }); src.addEventListener('closed', function(ev){ }); src.addEventListener('heartbeat', function(){}); src.onerror = function(){ try { src.close(); } catch(e){} setTimeout(function(){ subscribePluginOverlay(); }, 3000); }; return src; } catch(e){ return null; } }
      function postPluginMessage(event, payload){ try { fetch(new URL('/api/plugins/'+encodeURIComponent(pluginId)+'/overlay/messages', apiBase).toString(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ event: event, payload: payload||{} }) }); } catch(e){} }
      document.getElementById('btn-toast').onclick = function(){ logLine('显示提示消息'); postPluginMessage('ui-toast', { message: 'Hello from window sample!', options: { durationMs: 2500 } }); };
      document.getElementById('btn-alert').onclick = function(){ logLine('显示警告对话框'); postPluginMessage('ui-alert', { title: 'Notice', message: 'This is an alert from window sample.' }); };
      document.getElementById('btn-confirm').onclick = function(){ logLine('显示确认对话框'); postPluginMessage('ui-confirm', { title: 'Confirm', message: 'Proceed with operation?' }); };
      document.getElementById('btn-save-bg').onclick = function(){ var val = (document.getElementById('bg')||{}).value || ''; logLine('保存背景色: ' + (val || '默认')); applyBg(val||'#f4f4f4'); postPluginMessage('config-update', { uiBgColor: val }); };
      (function init(){ logLine('界面加载完成'); var keys = ['account','ui','stream']; fetchSnapshot(keys).then(function(){ subscribeReadonly(keys); }); subscribePluginOverlay(); })();
    </script>
  </body>
</html>
