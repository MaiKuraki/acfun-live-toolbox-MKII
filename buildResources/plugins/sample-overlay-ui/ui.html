<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>示例插件 UI</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { height: 100%; display: flex; flex-direction: column; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { display: flex; flex-direction: column; gap: 12px; padding: 12px; box-sizing: border-box; height: 100%; }
    .row { background: rgba(255,255,255,0.85); border-radius: 10px; box-shadow: 0 6px 24px rgba(0,0,0,.12); padding: 12px 14px; }
    .row .title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .intro .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type=text] { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; min-width: 160px; }
    button { padding: 8px 12px; border: 0; background: #2b78e4; color: #fff; border-radius: 6px; cursor: pointer; }
    button:hover { background: #225fb5; }
    .hint { color: #666; font-size: 12px; margin-top: 6px; }
    .store pre { margin: 0; padding: 0; font-size: 12px; line-height: 1.5; white-space: pre-wrap; max-height: 32vh; overflow: auto; }
    .send .inputs { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  </style>
  <script>
    (function(){
      var cfg = { uiBgColor: '#f4f4f4' };
      var storeSnap = {};
      var apiBase = String(window.location.origin || 'http://127.0.0.1:18299');
      function applyBg(color){ try { document.body.style.background = color || '#f4f4f4'; } catch(e){} }
      function isHexColor(str){ return /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(String(str||'')); }
      function mergeSlice(base, slice){ if(!base || typeof base!=='object') return slice||{}; for(var k in (slice||{})){ base[k] = Object.assign({}, base[k]||{}, slice[k]||{}); } return base; }
      function parsePluginId(){ try { var m = String(location.pathname||'').match(/\/plugins\/([^\/]+)/); return m && m[1] ? decodeURIComponent(m[1]) : ''; } catch(e){ return ''; } }
      var pluginId = parsePluginId();
      function renderStore(){ try { var el = document.getElementById('store'); if(el) el.textContent = JSON.stringify(storeSnap, null, 2); } catch(e){} }
      function fetchSnapshot(keys){ try { return fetch(new URL('/api/renderer/readonly-store/snapshot', apiBase).toString(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ keys: keys||[] }) }).then(function(r){ return r.json(); }).then(function(json){ if(json&&json.success){ storeSnap = mergeSlice(storeSnap, json.data||{}); renderStore(); } }); } catch(e){ return Promise.resolve(); } }
      function subscribeReadonly(keys){ try { var url = new URL('/sse/renderer/readonly-store/subscribe', apiBase); url.searchParams.set('keys', (keys||[]).join(',')); var src = new EventSource(url.toString()); src.addEventListener('readonly-store-init', function(ev){ try { var data = JSON.parse(ev.data||'{}'); storeSnap = mergeSlice(storeSnap, data); renderStore(); } catch(e){} }); src.addEventListener('readonly-store-update', function(ev){ try { var data = JSON.parse(ev.data||'{}'); storeSnap = mergeSlice(storeSnap, data); renderStore(); } catch(e){} }); src.addEventListener('heartbeat', function(){}); src.onerror = function(){ try { src.close(); } catch(e){} setTimeout(function(){ subscribeReadonly(keys); }, 3000); }; return src; } catch(e){ return null; } }
      function subscribePluginOverlay(){ if(!pluginId) return null; try { var url = new URL('/sse/plugins/'+encodeURIComponent(pluginId)+'/overlay', apiBase); var src = new EventSource(url.toString()); src.addEventListener('init', function(ev){ }); src.addEventListener('update', function(ev){ }); src.addEventListener('message', function(ev){ }); src.addEventListener('action', function(ev){ }); src.addEventListener('closed', function(ev){ }); src.addEventListener('heartbeat', function(){}); src.onerror = function(){ try { src.close(); } catch(e){} setTimeout(function(){ subscribePluginOverlay(); }, 3000); }; return src; } catch(e){ return null; } }
      function saveBg(){ var val = (document.getElementById('bg')||{}).value || ''; if(!val || !isHexColor(val)) { alert('请输入合法的十六进制颜色值，如 #2b2b2b'); return; } cfg.uiBgColor = val; applyBg(val); try { fetch(new URL('/api/plugins/'+encodeURIComponent(pluginId)+'/overlay/messages', apiBase).toString(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ event: 'config-update', payload: { uiBgColor: val } }) }); } catch(e){} }
      function sendText(){ var msg = (document.getElementById('msgText')||{}).value || ''; if(!msg){ alert('请输入要发送的文本'); return; } var payload = { text: String(msg), ts: Date.now() }; try { fetch(new URL('/api/plugins/'+encodeURIComponent(pluginId)+'/overlay/messages', apiBase).toString(), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ event: 'text', payload: payload }) }); } catch(e){} }
      window.addEventListener('DOMContentLoaded', function(){ applyBg(cfg.uiBgColor); var input = document.getElementById('bg'); if(input) input.value = cfg.uiBgColor; var keys = ['account','ui','role','rooms','stream']; fetchSnapshot(keys).then(function(){ subscribeReadonly(keys); }); subscribePluginOverlay(); var btn = document.getElementById('save'); if(btn) btn.addEventListener('click', saveBg); var sendBtn = document.getElementById('sendBtn'); if(sendBtn) sendBtn.addEventListener('click', sendText); });
    })();
  </script>
</head>
<body>
  <div class="app">
    <div class="row intro">
      <div class="title">开发者文档：UI 页面（三行布局）</div>
      <div>
        定位：插件在宿主应用中打开的设置/控制页，负责读写配置、展示只读仓库数据，并与 Overlay 进行交互。
      </div>
      <div>
        通信：
        1) 通过 <code>plugin-event</code> 接收渲染进程下发的只读仓库（事件：<code>readonly-store-init</code>、<code>readonly-store-update</code>）；
        2) 通过 <code>bridge-request</code> 发起配置读写（<code>get-config</code>/<code>set-config</code>）；
        3) 通过 <code>overlay-send</code> 将消息路由到 Overlay；未提供 <code>overlayId</code> 时按插件广播到所有 Overlay（示例 UI 的默认行为）。
      </div>
      <div>
        能力：
        - 展示并订阅只读仓库快照（房间、UI、角色、账号等切片）；
        - 提供配置输入与保存示例（字段：<code>uiBgColor</code>）；
        - 发送文本消息到 Overlay（事件名 <code>text</code>，结构：<code>{ text, ts }</code>）。
      </div>
      <div class="controls">
        <label for="bg">背景色：</label>
        <input id="bg" type="text" placeholder="#f4f4f4" />
        <button id="save">保存</button>
      </div>
      <div class="hint">提示：保存后将触发宿主配置更新事件，UI 会重新读取配置并应用背景色。</div>
    </div>
    <div class="row store">
      <div class="title">渲染进程只读仓库快照</div>
      <pre id="store"></pre>
    </div>
    <div class="row send">
      <div class="title">发送到 Overlay</div>
      <div class="inputs">
        <label for="msgText">文本：</label>
        <input id="msgText" type="text" placeholder="点我发送" />
        <button id="sendBtn">发送</button>
      </div>
      <div class="hint">未提供 overlayId 时默认广播到当前插件的所有 Overlay；事件名 <code>text</code>，结构：{ text, ts }。</div>
    </div>
  </div>
</body>
</html>
