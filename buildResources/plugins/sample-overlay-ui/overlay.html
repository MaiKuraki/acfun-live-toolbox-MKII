<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>示例插件 Overlay</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { height: 100%; display: flex; flex-direction: column; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { display: flex; flex-direction: column; gap: 12px; padding: 12px; box-sizing: border-box; height: 100%; }
    .row { background: rgba(255,255,255,0.85); border-radius: 10px; box-shadow: 0 6px 24px rgba(0,0,0,.12); padding: 12px 14px; }
    .row .title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .store pre { margin: 0; padding: 0; font-size: 12px; line-height: 1.5; white-space: pre-wrap; max-height: 32vh; overflow: auto; }
    .log .list { height: 40vh; overflow-y: auto; background: rgba(0,0,0,0.03); border-radius: 8px; padding: 8px; }
    .log .item { font-size: 13px; line-height: 1.6; padding: 4px 6px; border-bottom: 1px dashed #ddd; }
  </style>
  <script>
    (function(){
      var storeSnap = {};
      var apiBase = String(window.location.origin || 'http://127.0.0.1:18299');
      function parsePluginId(){ try { var m = String(location.pathname||'').match(/\/plugins\/([^\/]+)/); return m && m[1] ? decodeURIComponent(m[1]) : ''; } catch(e){ return ''; } }
      var pluginId = parsePluginId();
      function applyBg(color){ try { document.body.style.background = color || '#eeeeee'; } catch(e){} }
      function renderStore(){ try { var el = document.getElementById('store'); if (el) el.textContent = JSON.stringify(storeSnap, null, 2); } catch(e){} }
      function prependLog(text){ try { var list = document.getElementById('logList'); if(!list) return; var item = document.createElement('div'); item.className = 'item'; item.textContent = text; if(list.firstChild) list.insertBefore(item, list.firstChild); else list.appendChild(item); } catch(e){} }
      function subscribePluginOverlay(){ if(!pluginId) return null; try { var url = new URL('/sse/plugins/'+encodeURIComponent(pluginId)+'/overlay', apiBase); var src = new EventSource(url.toString()); src.addEventListener('init', function(ev){ try { prependLog('[init] '+String(ev.data||'')); } catch(e){} }); src.addEventListener('update', function(ev){ try { var data = JSON.parse(ev.data||'{}'); var ov = (data&&data.payload&&data.payload.overlay)||{}; var style = ov.style||{}; if(style.backgroundColor) applyBg(style.backgroundColor); renderStore(); prependLog('[update]'); } catch(e){} }); src.addEventListener('message', function(ev){ try { var data = JSON.parse(ev.data||'{}'); var evt = (data&&data.event)||''; var payload = (data&&data.payload)||{}; if(evt==='config-update'){ var color = String(payload.uiBgColor||'').trim(); if(color) applyBg(color); renderStore(); } else { prependLog('[message:'+evt+'] '+JSON.stringify(payload)); } } catch(e){} }); src.addEventListener('action', function(ev){ }); src.addEventListener('closed', function(ev){ }); src.addEventListener('heartbeat', function(){}); src.onerror = function(){ try { src.close(); } catch(e){} setTimeout(function(){ subscribePluginOverlay(); }, 3000); }; return src; } catch(e){ return null; } }
      function subscribeReadonly(keys){ try { var url = new URL('/sse/renderer/readonly-store/subscribe', apiBase); url.searchParams.set('keys', (keys||[]).join(',')); var src = new EventSource(url.toString()); src.addEventListener('readonly-store-init', function(ev){ try { var data = JSON.parse(ev.data||'{}'); storeSnap = Object.assign({}, storeSnap, data||{}); renderStore(); } catch(e){} }); src.addEventListener('readonly-store-update', function(ev){ try { var data = JSON.parse(ev.data||'{}'); storeSnap = Object.assign({}, storeSnap, data||{}); renderStore(); } catch(e){} }); src.addEventListener('heartbeat', function(){}); src.onerror = function(){ try { src.close(); } catch(e){} setTimeout(function(){ subscribeReadonly(keys); }, 3000); }; return src; } catch(e){ return null; } }
      window.addEventListener('DOMContentLoaded', function(){ applyBg('#eeeeee'); renderStore(); subscribePluginOverlay(); subscribeReadonly(['overlay']); });
    })();
  </script>
</head>
<body>
  <div class="app">
    <div class="row intro">
      <div class="title">开发者文档：Overlay 页面（三行布局）</div>
      <div>
        用途：用于在 OBS/浏览器源中承载插件的展示层，接收宿主通过 Wujie 总线转发的只读仓库快照与消息。
      </div>
      <div>
        使用方式：
        1) 首次加载会收到 <code>overlay-event</code> 的 <code>readonly-store-init</code>，其中包含从渲染进程同步的只读仓库快照；
        2) 样式/配置更新通过 <code>overlay-updated</code>（或 <code>overlay-update</code> 兼容）下发，<code>payload.overlay.style</code> 可用于更新背景等；
        3) 其他消息统一通过 <code>overlay-event</code> 通道传递（含 <code>{ event, payload, overlayId }</code>），页面可选择记录或渲染。
      </div>
      <div>
        能力：
        - 读取只读仓库（<code>window.__WUJIE_SHARED.readonlyStore</code>）用于初始渲染；
        - 监听宿主事件总线（<code>overlay-event</code>）进行增量更新与消息消费；
        - 可通过注入的 <code>props.api.action/send</code>（若声明）进行状态上报或消息发送（示例插件默认已注入）。
      </div>
    </div>
    <div class="row store">
      <div class="title">只读仓库快照</div>
      <pre id="store"></pre>
    </div>
    <div class="row log">
      <div class="title">消息展示区（最新在上）</div>
      <div id="logList" class="list"></div>
    </div>
  </div>
</body>
</html>
