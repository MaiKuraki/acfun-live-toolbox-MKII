## 目标
- 让插件能订阅“完整生命周期变化”的推送，覆盖插件启停、页面打开/关闭、Overlay创建/更新/关闭、连接状态、房间与直播状态、账号登录/登出、UI与设置变更、直播互动事件（弹幕、礼物、点赞、进入、关注等）。
- 在不破坏现有通道的前提下，统一事件命名与负载结构；必要时扩展现有SSE端点，将缺失的生命周期事件桥接到插件可订阅的通道。

## 现有可订阅通道
- 系统日志：`GET /sse/system/logs`（init/log/heartbeat）packages/main/src/server/ApiServer.ts:407
- 只读仓库：`GET /sse/renderer/readonly-store/subscribe?keys=...`（readonly-store-init/readonly-store-update/heartbeat）packages/main/src/server/ApiServer.ts:1145
- 单Overlay：`GET /sse/overlay/:overlayId`（init/update/message/action/closed/heartbeat）packages/main/src/server/ApiServer.ts:774
- 插件级Overlay消息中心：`GET /sse/plugins/:pluginId/overlay`（init + 持续事件：update/message/action/closed/heartbeat；支持回放）packages/main/src/server/ApiServer.ts:870
- 页面在线状态聚合：`plugin:<id>:page-status`（overlay-connected/overlay-disconnected/overlay-heartbeat，供渲染层IPC订阅）packages/main/src/persistence/PluginPageStatusManager.ts:44

## 最小粒度事件拆解
### 插件生命周期（hooks）
- beforeEnable / afterEnable / beforeDisable / afterDisable（packages/main/src/plugins/PluginLifecycle.ts:8，执行于PluginManager中）
- beforeInstall/afterInstall、beforeUninstall/afterUninstall、beforeUpdate/afterUpdate、onError/onRecover（同文件）
- 页面钩子：beforeUiOpen/afterUiOpen/uiClosed、beforeWindowOpen/afterWindowOpen/windowClosed、beforeOverlayOpen/afterOverlayOpen/overlayClosed（Overlay创建时已触发 before/afterOverlayOpen，packages/main/src/plugins/OverlayManager.ts:145,187；关闭时 overlayClosed：261,283）

### Overlay生命周期与交互
- overlay-created（创建后，packages/main/src/plugins/OverlayManager.ts:182）
- overlay-updated（样式/可见性/层级等更新，246；消息触发也会二次广播，392）
- overlay-closed（关闭后，277,494）
- overlay-action（update/close/show/hide/bringToFront 统一处理并对应更新，420–451）
- overlay-message（子页自定义事件，384–387；HTTP入队：POST /api/plugins/:pluginId/overlay/messages，packages/main/src/server/ApiServer.ts:966）
- overlay连接状态（SSE客户端）：overlay-connected/overlay-disconnected/overlay-heartbeat（packages/main/src/persistence/PluginPageStatusManager.ts:45,61,66）

### 只读仓库切片（快照/增量）
- account：isLoggedIn、profile（packages/renderer/src/stores/account.ts:284,295）
- ui：theme/sidebarCollapsed/isFullscreen/windowSize（packages/renderer/src/stores/ui.ts:94,111）
- stream：rtmpUrl/streamKey/expiresAt（packages/renderer/src/stores/stream.ts:69,81）
- 其他可能切片：room/role/plugin/console（存在store与Reporter整合点，packages/renderer/src/utils/readonlyReporter.ts:82,116）

### 房间与直播状态
- roomAdded/roomRemoved（packages/main/src/rooms/RoomManager.ts:74,115）
- roomStatusChange：connecting/open/closing/closed/reconnecting/error（packages/main/src/types/contracts.ts:33；触发位置 packages/main/src/rooms/RoomManager.ts:189,205；WebSocket广播 packages/main/src/index.ts:wsHub.broadcastRoomStatus）
- roomReconnectFailed（packages/main/src/rooms/RoomManager.ts:261）
- 直播开始/结束（HTTP接口存在，packages/main/src/server/ApiServer.ts:178–182；当前未直接以SSE推送）

### 直播互动事件（统一归一化）
- NormalizedEventType 白名单：`danmaku`、`gift`、`follow`、`like`、`enter`、`system`、`bananaCount`、`displayInfo`、`topUsers`、`redpackList`、`chatCall`、`chatAccept`、`chatReady`、`chatEnd`、`kickedOut`、`violationAlert`、`managerState`、`end`（packages/main/src/types/contracts.ts:24–28）
- 事件产生与入库：adapter → ensureNormalized → SQLite writer（packages/main/src/rooms/RoomManager.ts:211–233）

### 系统事件
- system:logs（init/log/heartbeat）（packages/main/src/server/ApiServer.ts:407）
- 错误/诊断（IPC与日志管理，packages/main/src/ipc/ipcHandlers.ts:147）

## 缺口与一致性问题
- 插件级SSE未明确推送“lifecycle”事件；overlay-wrapper已监听 `lifecycle`（packages/main/src/server/templates/overlay-wrapper.html:266），但当前发布端只含 update/message/action/closed。
- 房间/直播状态未桥接到插件SSE；仅通过WsHub与渲染层使用。
- 只读仓库订阅端点文档有路径差异（模板中用 `/sse/renderer/readonly-store`，实际为 `/sse/renderer/readonly-store/subscribe`）。

## 推送方案（不改变现有端点设计）
### 事件统一命名与负载
- 约定 `event` 字段为语义名，`meta.kind` 为类别，`payload` 为数据。
- 类别与语义：
  - lifecycle：plugin-enabled/disabled、before/afterUiOpen、before/afterOverlayOpen/uiClosed/overlayClosed 等
  - update：overlay-updated（含 style/visible/position/size 变化）
  - action：overlay-action（payload: { action, data }）
  - message：overlay-message（自定义事件）
  - status：overlay-connected/overlay-disconnected/overlay-heartbeat
  - room：room-added/room-removed/room-status-change/room-reconnect-failed
  - store：readonly-store-init/readonly-store-update（按keys过滤）
  - danmaku：normalized-event（payload: NormalizedEvent）

### 桥接映射（发布侧）
- PluginLifecycleManager → DataManager.publish(`plugin:<id>:overlay`, { event, payload }, { meta.kind: 'lifecycle' })。
- RoomManager 事件 → 同频道发布：
  - roomAdded/roomRemoved → kind: 'room'，event: 'room-added'|'room-removed'
  - roomStatusChange → kind: 'room'，event: 'room-status-change'，payload: RoomStatusPayload（packages/main/src/types/contracts.ts:38）
  - event(enriched) → kind: 'danmaku'，event: 'normalized-event'，payload: NormalizedEvent（packages/main/src/types/contracts.ts:9）
- PluginPageStatusManager → 合并进插件SSE响应（现有心跳时已调用statusManager.overlayClientHeartbeat）或新增 `GET /sse/plugins/:pluginId/status`（若不希望混流）。
- Renderer ReadonlyStore → 保持现状；子页通过 overlay-wrapper 已转发到 `overlay-event`（packages/main/src/server/templates/overlay-wrapper.html:72,86）。

### 客户端（插件UI/Overlay页）消费建议
- 首选 `GET /sse/plugins/:pluginId/overlay`，监听：init/update/message/action/closed/heartbeat + lifecycle/room/danmaku/store。
- Fallback `GET /sse/overlay/:overlayId` 在插件禁用或通道不可用时继续获取 overlay 专属事件与只读仓库更新（overlay-wrapper 已实现回退）。
- 通过只读仓库 `keys=account,ui,stream,room` 获取登录状态/设置/推流信息等。

## 校验与向后兼容
- 保持现有事件（update/message/action/closed）不变；新增类别以 `meta.kind` 区分，避免破坏现有监听。
- overlay-wrapper 已对 `overlay-updated`/`overlay-update` 做兼容；继续沿用。
- 不在代码中保留回退旧逻辑；以发布端一致化为准则（满足用户规则）。

## 交付项
- 事件清单（如上）与命名规范
- 发布侧桥接点列表（对应文件与函数）
- 插件UI接入指南（推荐监听事件与数据结构）

请确认是否按该方案推进，将缺失的 lifecycle/room/danmaku 类事件桥接到插件SSE通道，以实现“完整生命周期变化推送”。