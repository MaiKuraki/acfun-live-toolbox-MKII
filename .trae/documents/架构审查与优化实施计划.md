## 总览
- 目标：对 ACFun Live Toolbox 全仓进行架构审查，识别结构与依赖问题、性能瓶颈与冗余，并提出可执行的优化方案。
- 范围：`packages/main`（主进程/服务/插件系统/持久化）、`packages/renderer`（Vue3 渲染层）、`packages/preload`（受控暴露）、`buildResources/plugins`（示例/内置插件）、根层工作区与 CI。
- 成果：问题清单 + 具体修复改造任务 + 验证与交付方式。

## 代码结构审查
- Monorepo & Workspaces：根 `package.json` 管理 `packages/*`，主进程/渲染层/预加载分包清晰；资源与示例位于 `buildResources/plugins/*`。
- 主进程分层：
  - 服务层：`server/ApiServer.ts`（HTTP/SSE/WS）、`AcfunApiProxy.ts`、`WsHub.ts`、`TokenManager.ts`。
  - 插件层：`plugins/*`（生命周期/安装更新/静态托管/热重载/性能监控/缓存/懒加载）。
  - 持久化层：`persistence/*`（SQLite3、查询、CSV 导出、消息中心）。
  - 启动层：`bootstrap/*`（单实例/硬件加速/窗口管理/依赖守卫）。
  - 其他：`rooms/*`（连接管理）、`ipc/*`、`logging/*`、`config/*`、`types/*`、`utils/*`。
- 渲染层：Vue 3 + Pinia + Vue Router，页面/组件/状态仓分布合理；支持 `wujie-vue3` 微前端与示例插件托管页。
- 结论：目录边界清晰、职责分离合理；后续重点在“服务层路由冗余”与“插件/服务相互依赖”两处减耦与收敛。

## 技术栈评估
- 主技术：Electron 39、Node ≥22、TypeScript 5.8/5.9、Vite 7、Vue 3.5。
- 服务端：Express、WS、SQLite3、Helmet/CORS/Compression/Morgan，SSE 用于消息中心。
- AcFun API：`acfunlive-http-api` 持久化集成（位于 `packages/main/node_modules/acfunlive-http-api`，声明在 `dist/index.d.ts`）。
- 风险：根层 `express@^5` 与主进程 `express@^4.18.2` 并存，类型与运行期 API 可能不一致；TypeScript 版本在根与子包不同步，存在类型收敛风险。

## 依赖关系分析
- 双向（循环）依赖：
  - `ApiServer.ts` ↔ `PluginManager.ts`（服务层引入插件管理器，插件管理器引入服务层）
    - 引用位置：`packages/main/src/server/ApiServer.ts:15` 与 `packages/main/src/plugins/PluginManager.ts:2`
  - `ApiServer.ts` ↔ `ConsoleManager.ts`（同理）
    - 引用位置：`packages/main/src/server/ApiServer.ts:16` 与 `packages/main/src/console/ConsoleManager.ts:2`
- 影响：初始化顺序脆弱、类型环导致 `undefined`，耦合过高；建议以接口+依赖注入替代显式 import。
- 版本冲突：
  - 根 `package.json`：`express@^5.1.0`、`@types/express@^5.0.3`
  - `packages/main/package.json`：`express@^4.18.2`、`@types/express@^4.17.21`
- 其他一致性问题：TS 版本根（5.9.3）与子包（5.8.3）不一致。

## 性能瓶颈检测
- HTTP 中间件：`morgan('combined')` 在生产环境可能过度 IO；`compression` 已对 SSE 做过滤，但仍建议按环境开关。
- SQLite3：索引齐全（`DatabaseManager.ts`），写入在 `EventWriter` 队列做缓冲（良好）；`pageSize` 上限 1000（`ApiServer.ts:255–266` 校验）可保守。
- SSE 消息中心：`DataManager` 使用 JSONL 追加 + 内存队列，缺轮转与文件大小控制；在高负载下可能产生磁盘膨胀与恢复耗时。
- 插件系统：热重载与监控组件较多，但调用面以 `PluginManager` 为主；当前无明显热点，但耦合度偏高可能影响可维护性。

## 冗余与过度设计检查
- 路由重复定义（必须删除）：
  - `GET /api/diagnostics` 重复：`packages/main/src/server/ApiServer.ts:286–303` 与 `342–359`
  - `GET /api/logs` 重复：`packages/main/src/server/ApiServer.ts:306–322` 与 `361–378`
- 文件名不一致：`PluginManager.reloadPluginInfo()` 读取 `plugin.json` 而全仓使用 `manifest.json`，存在潜在行为不一致。
  - 位置：`packages/main/src/plugins/PluginManager.ts:1749–1769`
- 依赖未使用：`node-fetch` 与 `@types/node-fetch` 出现在 `packages/main/package.json` devDependencies，主代码未引用，建议移除。
- 版本不一致：TypeScript、Express 版本在不同层不一致（见“依赖分析”）。
- 抽象层冗余：`PluginCoordinator` 仅被 `PluginManager` 引用，无跨模块调用；可保留但不应扩大耦合。

## 优化方案
### 1. 路由冗余清理
- 删除 `ApiServer.ts` 中重复的 `GET /api/diagnostics` 与 `GET /api/logs` 路由块，仅保留一处实现。
- 验证：本地 `typecheck`、快速启动校验首页 `/`、`/api/health`、`/api/logs`、`/api/diagnostics`。

### 2. 统一 Express 版本与类型
- 策略 A（推荐）：统一到 `express@^5` 与 `@types/express@^5`，并确认路由语法（命名通配符、404 handler）与注释一致。
- 策略 B：统一到 `express@^4.18` 与对应类型；若选择此路线，则调整 `'/plugins/:id/:rest(.*)'` 与相关语义到 v4 可用子路由写法。
- 选择以项目稳定性与依赖锁定为准，避免双版本并存。

### 3. 解除循环依赖
- 抽象接口：在 `packages/main/src/types/contracts.ts` 定义 `IPluginManager`、`IConsoleManager` 极简接口（仅暴露 `getInstalledPlugins()`、`registerPluginRoute()`、`getCommands()`、`createSession()` 等）。
- 依赖注入：`ApiServer` 不再 import 具体类，而仅持有接口实例引用（通过构造或 `setPluginManager()` / `setConsoleManager()` 注入）。
- `ConsoleManager` 同理不 import `ApiServer`，仅在需要时接收接口引用。
- 验证：编译与运行检查 + IPC/HTTP 端到端冒烟。

### 4. 行为一致性修复
- `reloadPluginInfo()` 改为读取 `manifest.json`，与安装/加载逻辑一致。
- `rollbackPluginUpdate()` 使用局部 `wasEnabled` 判断回滚后是否重新启用，避免使用已更新的 `plugin.enabled`。
- 清理未使用 devDependencies：移除 `node-fetch` 与 `@types/node-fetch`（主代码未用）。
- TypeScript 版本统一到子包版本（或根版本），以 `pnpm -r` 方式对齐。

### 5. 性能与可靠性提升
- 中间件环境开关：`morgan`、`compression` 按 `NODE_ENV` 控制；生产关闭 `morgan`，`compression` 保留 SSE 过滤。
- `DataManager`：
  - 增加 JSONL 文件轮转（按大小/时间），保留最近 N 段；
  - 增加持久化错误告警与上限保护；
  - 维持现有 TTL 清理周期（10s），可调参。
- SSE：心跳频率保留（`SSE_HEARTBEAT_MS = 15000`），增加写失败重试与背压日志抑制（限制打印频率）。

## 验证与交付
- 验证维度：
  - 类型检查：`pnpm -r run typecheck`
  - 启动与路由：`start` 后检查 `/`、`/api/health`、插件静态托管、SSE 通道、AcFun 代理（仅端到端接口层，不做 mock）。
  - 依赖一致性：`pnpm list express` 与 TypeScript 版本一致性检查。
- 测试约束：遵循项目/用户规则，测试仅限静态走查与 typecheck，不引入 `acfunlive-http-api` mock。

## 里程碑与任务
- M1 路由冗余清理与类型检查（半天）
- M2 Express 版本统一与循环依赖解除（1–1.5 天）
- M3 行为一致性修复（`manifest.json`、回滚逻辑、依赖清理）（0.5 天）
- M4 性能与可靠性提升（中间件开关、消息中心轮转）（1 天）
- M5 验证与交付（0.5 天）

## 风险与回滚
- Express 升级可能影响路由匹配；保留 A/B 方案，必要时切换到 v4 路线。
- 循环依赖拆解需谨慎调整构造顺序；通过接口与注入逐步迁移，避免一次性重写。
- 消息中心轮转需观测现有磁盘使用与恢复流程，以免影响 SSE 订阅与最近记录回放。

## 关键文件引用
- 路由重复：`packages/main/src/server/ApiServer.ts:286–303`、`342–359`；`306–322`、`361–378`
- 循环依赖：`packages/main/src/server/ApiServer.ts:15–16` ↔ `packages/main/src/plugins/PluginManager.ts:2`、`packages/main/src/console/ConsoleManager.ts:2`
- `reloadPluginInfo()` 文件名不一致：`packages/main/src/plugins/PluginManager.ts:1749–1769`
- `rollbackPluginUpdate()` 回滚后启用条件：`packages/main/src/plugins/PluginManager.ts:1528–1531`
- 心跳常量：`packages/main/src/config/config.ts:1`
- SQLite 初始化与索引：`packages/main/src/persistence/DatabaseManager.ts:46–87`
- `acfunlive-http-api` 代理：`packages/main/src/server/AcfunApiProxy.ts`
