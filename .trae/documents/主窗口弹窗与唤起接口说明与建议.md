## 目标
- 通过 HTTP 接口在主窗口或插件窗口弹出全局提示（toast/alert/confirm）。
- 通过 HTTP 接口控制窗口显示/聚焦/关闭，支持多插件窗口按 windowId（或 pluginId）指定；不传时默认控制“自身”（通过头部/参数识别）。
- 提供获取“自身窗口ID”的接口，便于调用方在多窗口场景下自助识别。

## 现有能力与依赖
- 弹窗 IPC：`popup.toast/alert/confirm`（packages/main/src/ipc/ipcHandlers.ts:1595,1609,1623；renderer 接收 packages/renderer/src/main.ts:23–35）。
- 主窗口管理：WindowManager（packages/main/src/bootstrap/WindowManager.ts）。
- 插件窗口管理：PluginWindowManager（packages/main/src/plugins/PluginWindowManager.ts），支持 `open/focus/close/list/send`。
- 速率限制/CORS：ApiRateLimitManager（packages/main/src/server/ApiRateLimitManager.ts）、AcfunApiProxy路由例子（packages/main/src/server/AcfunApiProxy.ts）。

## 接口设计
### 1) 弹窗接口
- `POST /api/popup`
- Headers：`Content-Type: application/json`; 可选 `X-Plugin-ID: <pluginId>` 指定目标插件窗口；缺省为主窗口
- Body：
  - `action`: `toast` | `alert` | `confirm`（必填）
  - `title`: string（alert/confirm 可选）
  - `message`: string（必填）
  - `options`: object（可选）
  - `windowId`: string（可选；优先级高于 `X-Plugin-ID`；用于针对某一插件窗口）
- Response：
  - `200 { success: true, result?: boolean }`（confirm 返回布尔）
  - 错误：`404` 目标窗口不存在；`400` 参数错误

### 2) 窗口控制接口
- `POST /api/windows/show`
  - Body：`windowId?: string` | `pluginId?: string`；缺省主窗口
  - 执行：`win.show(); win.focus()`
- `POST /api/windows/focus`
  - Body 同上；仅 `win.focus()` 并 `show` 以确保可见
- `POST /api/windows/close`
  - Body 同上；`win.close()`（主窗口需谨慎，仅在允许时执行）
- `GET /api/windows/list`
  - 返回：`[{ windowId: <pluginId>, visible: boolean, focused: boolean }]`（主窗口另返回 `windowId: 'main'`）
- `GET /api/windows/self`
  - 识别“自身”：优先从 `X-Plugin-ID`，否则返回 `main`
  - 返回：`{ windowId: string }`

### 3) 自身识别规则
- 来自插件窗口的请求：在加载时由渲染页附加 `X-Plugin-ID`（已有插件页上下文可以获取 `pluginId`，如 `#/plugins/:pluginId/window`）。
- 若无 `X-Plugin-ID` 且未显式传 `windowId/pluginId`，则视为主窗口调用。

## 技术实现
- ApiServer 增加窗口管理器引用（类似 `setPluginManager`）：
  - 新增 `setWindowManagers({ windowManager, pluginWindowManager })` 注入。
  - 在 `configureRoutes` 中注册上述 `/api/popup` 与 `/api/windows/*` 路由。
- 执行逻辑：
  - 目标窗口解析顺序：`windowId`（匹配插件窗口）→ `X-Plugin-ID` → 主窗口。
  - 弹窗：主窗口用 `mainWindow.webContents.send('renderer-global-popup', {...})`；插件窗口用 `PluginWindowManager.send(pluginId, 'renderer-global-popup', {...})`。
  - 控制：主窗口通过 `WindowManager.getMainWindow()`；插件窗口通过 `PluginWindowManager.focus/close` 等。
- 安全与频控：
  - 继承现有 `rateLimitManager`（以 `X-Plugin-ID` 或 IP 为键）；每次请求 `recordRequest`。
  - CORS：沿用 `ApiServer` 默认 CORS；仅本地来源允许。

## 返回值与错误格式
- 与现有代理一致：`{ success: boolean, data?: any, error?: string, code?: number }`。

## 最小改动列表
- 修改：`packages/main/src/server/ApiServer.ts`（新增路由与注入方法）。
- 仅使用现有管理器实例；不改变旧接口；不保留“兼容旧版本”的回退代码。

## 验证
- 单元验证：
  - `POST /api/popup` 对主窗口与插件窗口验证。
  - `POST /api/windows/show/focus/close` 在多窗口场景下按 `pluginId` 指向正确窗口。
  - `GET /api/windows/self` 在主窗口与插件窗口分别返回 `main` 与对应 `pluginId`。
- 仅静态代码走查与类型检查，按项目规则不执行集成测试。

## 后续
- 若确认方案，我将按上述设计实现，并在 API 文档中补充这些端点说明（API-Core-1.0.0.md 按模块新增 System/Window 章节）。