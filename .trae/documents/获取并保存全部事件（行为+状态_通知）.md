## 目标
- 参考 acfunlive-http-api 最新文档的统一回调模型，完整接入并保存所有事件：行为事件（含 `danmuInfo`）与状态/通知/结束事件。
- 保持现有 SQLite 表结构不变，通过类型扩展与适配器分派实现全量入库。

## 覆盖范围
- 行为事件：`Comment`、`Like`、`EnterRoom`、`FollowAuthor`、`ThrowBanana`、`Gift`、`RichText`、`JoinClub`、`ShareLive`（均含 `danmuInfo`）
- 状态事件：`bananaCount`、`displayInfo`、`topUsers`、`recentComment`、`redpackList`、`chatCall/Accept/Ready/End`
- 通知事件：`kickedOut`、`violationAlert`、`managerState`
- 结束事件：`end`

## 技术改动
1. 类型扩展（存储与查询白名单）
- 更新 `packages/main/src/types/contracts.ts` 的 `NormalizedEventType`，加入：
  - `bananaCount`、`displayInfo`、`topUsers`、`redpackList`、`chatCall`、`chatAccept`、`chatReady`、`chatEnd`、`kickedOut`、`violationAlert`、`managerState`、`end`
- 更新 `packages/main/src/events/normalize.ts`：
  - 扩展 `ALLOWED_TYPES` 与 `clampType(t)`，将上述字符串映射为对应的新枚举；未知仍归为 `system`。

2. 适配器派发与内容抽取
- 在 `packages/main/src/adapter/AcfunAdapter.ts` 的 `handleDanmuEvent`：
  - 增加对状态/通知/结束事件的显式分支：
    - `bananaCount`：`content=String(data)`
    - `displayInfo`：`content=\"watchingCount=..., likeCount=..., likeDelta=...\"`
    - `topUsers`：`content=\"count=<n>\"`
    - `recentComment`：逐条 Comment 转换为弹幕事件并分派（文档已声明逐条触达；此处仅兜底）
    - `redpackList`：`content=\"count=<n>\"`
    - `chatCall/Accept/Ready/End`：`content=\"chat<Stage>\"`
    - `kickedOut/violationAlert`：`content=reason`
    - `managerState`：`content=String(number)`
    - `end`：`content=\"live_ended\"`
  - 统一通过现有 `emitUnifiedEvent(type, message)` 路径发射；`message.raw` 保留原始事件，`roomId` 使用当前房间。

3. 入库策略（无表结构变更）
- `EventWriter` 已将 `NormalizedEvent.content` 写入 `events.payload`（NOT NULL）。
- 对于非文本的复杂事件，`content` 使用精简摘要（不超过 500 字符）；详细原始数据置于 `raw_data`（JSON），便于后续解析与 UI 展示。

4. 查询与过滤兼容
- `QueryService` 无需改动 SQL，仅因 `NormalizedEventType` 扩展而支持新的类型过滤；
- 现有 `q/user_kw/room_kw` 等全文检索依旧可用（`payload/raw_data` 均参与）。

## 验证
- 静态走查与类型检查：
  - 事件分派覆盖所有分支，写库日志显示新增类型的 `type/payload`。
  - 样本查询：`getEventsSample` 查看最新事件类型分布包含新类型；`queryEvents` 按新类型过滤返回正确的 `content/raw`。
- 不编写或运行测试；遵循项目规则。

## 风险与注意
- 不改变 DB schema 与依赖版本；新增类型仅在应用层扩展，兼容现有数据。
- `content` 作为摘要可能不足以还原复杂数据，详细数据需从 `raw_data` 读取；这是预期设计。

## 交付
- 更新类型与规范化映射；
- 在适配器中实现状态/通知/结束事件的分派与内容摘要；
- 通过静态验证确认所有路径贯通、可查询。