## 目标
- 让页面正确显示数据库中的弹幕数据
- 明确并修复从“事件产生→写库→查询API→前端渲染”的整条链路

## 可能问题定位
- 数据库路径不一致：`DatabaseManager` 使用 `app.getPath('userData')`，而项目末尾存在 userData 重定向逻辑但执行时机晚（`index.ts:247-259`），可能导致用户查看的 `events.db` 与进程读取的不是同一个目录
- API 查询为空：`GET /api/events` 的过滤参数与库中实际数据不匹配（例如 `room_id`、`types`、时间范围），或房间实际未连接写入
- WAL 读写：WAL 模式正常，但需要确认同一连接读取；如多进程读写可能出现误判

## 方案
### 1. 增加后端诊断端点（只读）
- 新增 `GET /api/debug/db-info`
  - 返回：`{ dbPath, eventsCount, latestEventTs, latestRoomIds: string[], roomsMetaCount }`
  - 用于确认服务实际读取的数据库路径以及基本数据规模
- 新增 `GET /api/debug/events/sample`
  - 返回最近 `N` 条 `events` 原始行（包含 `room_id/type/ts`），用于核对过滤参数

### 2. 统一数据库路径初始化时机
- 将 userData 重定向逻辑（`index.ts:247-259`）前移到 `main()` 之前，确保 `DatabaseManager.initialize()` 与服务读写的路径与用户看到的路径一致
- 在 `DatabaseManager.initialize()` 成功时记录 `dbPath` 到日志（已有 `console.info('Database connected at:', this.dbPath)`），并通过诊断端点可见

### 3. 校验与放宽查询参数（前端）
- 在首次加载历史弹幕时先不传 `type` 参数，确认能拿到数据；再应用过滤
- 当 `selectedRoomId` 为空或 `rooms` 列表为空时显示提示并提供刷新按钮（保持现有逻辑即可）
- 保持分页计算：`allFilteredDanmu.length` 用作总数，`filteredDanmu` 仅切片

### 4. 事件写入确认
- 通过 IPC `room.list` 查看已连接房间与事件计数（`packages/main/src/ipc/ipcHandlers.ts:309-323`），确保房间连接且有事件写入
- 若房间未连接，则通过 UI 或 IPC 连接房间，以产生事件并写库

### 5. 验证步骤
- 调用 `GET /api/debug/db-info`，确认 `dbPath` 与用户观察的 `events.db` 同一目录；确认 `eventsCount > 0`
- 调用 `GET /api/events/rooms`，返回历史房间列表非空
- 调用 `GET /api/events?room_id=<rid>&page=1&pageSize=20`（不带 `type`）应返回 items 非空
- 前端页面显示弹幕；再逐步开启类型过滤确认无误

### 6. 风险与处理
- 如数据库确有数据但 `room_id` 与前端选择不一致（例如使用了 liveID 而非 roomId），通过 `sample` 端点核对并修复映射
- 如确实无数据：检查 `RoomManager` 是否收到事件并写入（`EventWriter` 已启用），必要时在 UI 增加连接房间的交互提示

请确认以上方案，我将新增诊断端点、前移 userData 重定向时机，并在前端放宽首次查询过滤以确保数据可见。