## 目标
- 统一由主进程触发生命周期：仅保留 `afterloaded` 与 `beforeUnloaded`，集中在主进程发布 SSE，并兼容“插件未定义该方法时静默跳过”。
- 移除安装/更新/启用/禁用/卸载相关钩子与旧兼容代码，不保留任何回退逻辑。
- 消除 VM2 中 ESModule 语法错误，将现有插件 `export default` 改为 CommonJS `module.exports`。
- 按插件 manifest 驱动沙箱依赖注入（`injectWs`、`mocks`），避免硬编码并解决 `ws` 与 `obs-websocket-js` 的加载问题。
- 降噪：当方法不存在时，主/Worker 侧均不输出“method not found”噪音日志。

## 变更范围
- `buildResources/plugins/sample-overlay-window/index.js`：把 `export default` 改为 `module.exports`，不动函数体。
- `buildResources/plugins/window-plugin-template.js`：同上，统一 CommonJS。
- `packages/main/src/plugins/ProcessManager.ts`：
  - `executeInPlugin(...)` 支持 `options.optional`，方法缺失时静默跳过，并把该标志透传给 Worker。
  - `stopPluginProcess(...)` 在停止前可选调用 `beforeUnloaded` 并发布 SSE。
  - `buildSandboxConfig(...)`：按 manifest 注入 `ws` 与 `mocks`（`obs-websocket-js`）。
- `packages/main/src/plugins/worker/plugin-worker.js`：
  - 识别 `optional`，方法缺失时不打印“method not found”。
  - 注入 `console`，并按 `cfg.injectWs` 与 `cfg.mocks` 执行依赖注入。
- `packages/main/src/plugins/PluginManager.ts`：
  - 在 `process.started` 后仅通过 VM 可选调用 `afterloaded` 并发布 SSE。
  - `onError` 由主进程同时回收并集中发布 SSE。
  - 清除剩余的安装/更新/启用/禁用/卸载钩子注册与调用残留。
- `packages/main/src/server/SseQueueService.ts` 与 `packages/main/src/server/ApiServer.ts`：确保生命周期事件通过队列集中发布（若代码已在位，仅做验证）。
- `packages/main/src/index.ts`：启动前打印持久化配置快照与关键插件启用状态。

## 实施步骤
1. 转换插件导出模式为 CommonJS：
   - `sample-overlay-window/index.js`：`export default { ... }` → `module.exports = { ... }`。
   - `window-plugin-template.js`：同上。
2. 可选钩子执行与降噪：
   - 在主进程 `executeInPlugin` 增加 `optional` 参数，方法缺失直接返回，不抛错。
   - Worker 侧解析消息里的 `optional`，方法不存在不输出“method not found”。
3. 生命周期统一：
   - `process.started` 后：仅调用插件 `afterloaded`（可选）→ 发布 `plugin-after-loaded` SSE。
   - `stopPluginProcess` 前：仅调用插件 `beforeUnloaded`（可选）→ 发布 `plugin-before-unloaded` SSE。
   - `onError`：主进程集中发布 `plugin-error` SSE，并转发给插件 `onError`（如存在）。
4. 沙箱依赖注入（manifest 驱动）：
   - `buildSandboxConfig` 与 Worker 中依据 `runtime.injectWs` 与 `runtime.mocks` 注入 `ws`、`obs-websocket-js`，不硬编码路径。
5. 清理冗余钩子与旧兼容代码：
   - 彻底删除 `beforeLoaded/beforeInstall/afterInstall/beforeUpdate/afterUpdate` 及启用/禁用/卸载相关注册与调用残留。
6. 启动前诊断输出：
   - 在 `index.ts` 打印持久化插件配置快照与关键插件（如 `obs-assistant`）的启用状态。

## 验证与交付
- 启动应用并观察日志：
  - 看到 `process started` 后发布 `plugin-after-loaded`，插件侧如未定义 `afterloaded` 不报错且无噪音日志。
  - 停止插件时发布 `plugin-before-unloaded`，同样可选执行。
  - `sample-overlay-window` 不再出现 ESModule 语法错误；`obs-assistant` 不再报 `ws` 相关错误。
  - `onError` SSE 由主进程集中发布，插件侧不再自行发布生命周期 SSE。
- 不新增测试用例与运行测试（遵循“除非明确提出，禁止自行创建/运行测试”）。
- 所有修改遵循现有代码风格，不引入注释与冗余函数；不保留任何回退代码。