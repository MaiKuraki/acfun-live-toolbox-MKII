# 目标
- 消除插件子系统的循环依赖与高耦合，明确边界与职责
- 收敛外部 API 访问路径与认证单源，降低重复实现
- 统一连接池、心跳与定时器调度，减少主线程抖动
- 优化 SQLite 与 JSONL 写入策略，提升在高负载下的稳定性

## 范围
- 主进程（插件、服务器、持久化、适配层）
- 不改动渲染层交互协议；维持对 `acfunlive-http-api` 的真实请求（不使用 mock）
- 仅进行静态代码走查与类型检查验证，不编写/运行测试用例

## 关键改动
- 插件子系统解环：将 `PluginInfo/PluginManifest` 类型迁移到 `packages/main/src/types/`；运行时交互改为事件/接口，移除双向 `import`
- 外部 API 单一路径：统一由服务端 `AcfunApiProxy` 提供访问入口；插件桥 `ApiBridge` 改为经本地 HTTP 调用代理；认证统一由 `TokenManager` 提供，不在适配器/桥中重复校验
- 连接池统一：以 `packages/main/src/plugins/ConnectionPoolManager.ts` 为基座，增加标签化策略（HTTP/HTTPS/TCP/WS/AcFun）；删除适配层 `ConnectionPoolManager` 并迁移引用
- 心跳与定时器集中：新增 `HeartbeatScheduler`（单调度器、错峰执行）；`ApiServer` SSE 与 `WsHub` 统一使用调度器；移除每连接 `setInterval`
- SQLite/JSONL 写优化：`EventWriter` 自适应批次与事务分片，加入 `busy_timeout`；`DataManager` 改为异步批缓冲写；保留 WAL 与索引策略
- 速率限制持久化：`ApiRateLimitManager` 改为定时批写、端点粒度令牌桶/漏桶；请求路径避免同步 IO
- 清理冗余：删除 legacy 路由/模板与未接入 TODO；统一命名与导出，移除回退代码

## 实施分阶段
### Phase 1：插件类型与依赖解环
- 新增 `packages/main/src/types/plugin.ts`（导出 `PluginInfo/PluginManifest`）
- 修改 `PluginLifecycle.ts / PluginUpdater.ts / PluginVersionManager.ts / PluginManager.ts`：仅从 `types` 导入类型；运行时交互改为事件/接口传值
- 验收：无循环 `import`；`pnpm -r run typecheck` 通过

### Phase 2：统一外部 API 访问与认证单源
- 在 `ApiBridge.ts` 将 `acfun.*/callAcfun` 路径改为 HTTP 调用 `ApiServer` 的 `/api/acfun/*`
- 在 `TokenManager.ts` 保持唯一认证事实来源；删除适配器/桥的令牌再应用与重复有效性判断
- 验收：`ApiBridge` 无直接 `acfunlive-http-api` 引用；类型检查通过

### Phase 3：连接池统一与迁移
- 保留并增强 `plugins/ConnectionPoolManager.ts`（标签与分组复用、限长队列、指数退避）
- 删除 `adapter/ConnectionPoolManager.ts`；更新适配/插件代码引用到统一池
- 验收：仓内仅存在单一连接池实现；类型检查通过

### Phase 4：SSE/WS 心跳与定时器集中
- 新增 `utils/HeartbeatScheduler.ts`（统一心跳：SSE 15s、WS 30s；错峰、分片广播）
- 修改 `ApiServer.ts` 与 `WsHub.ts`：移除每连接心跳；广播分片与序列化缓存；日志采样
- 验收：无重复 `setInterval`；广播路径不线性阻塞；类型检查通过

### Phase 5：SQLite/JSONL 写优化
- `DatabaseManager.ts` 增加 `PRAGMA busy_timeout=3000; temp_store=MEMORY; journal_size_limit=10485760`
- `EventWriter.ts`：自适应 `flushInterval`、事务分片与失败项单独重试；避免小事务放大
- `DataManager`：改为 `fs.promises.appendFile` 异步批写，定时刷盘
- 验收：类型检查通过；关键路径不含同步文件写

### Phase 6：速率限制与持久化
- `ApiRateLimitManager.ts`：将 `saveToFile` 改为定时批写；引入端点粒度令牌桶/漏桶；在 `AcfunApiProxy.ts` 路径避免同步 IO
- 验收：类型检查通过；持久化写入频率降低

### Phase 7：清理与一致性
- 删除未接入 TODO/legacy 代码；统一命名与导出；移除回退分支
- 复核 `ApiServer` 路由模块化与接口注入（健康/数据/插件托管/AcFun 代理）
- 验收：代码走查边界清晰；类型检查通过

## 验证与约束
- 验证：全仓 `pnpm -r run typecheck`；静态代码走查；不启动渲染进程开发服务器
- 约束：不创建/运行测试；不使用 mock；安装命令使用 `pnpm`

## 风险与缓解
- API 访问路径迁移风险：逐文件替换并保持路由契约一致；完成后删除旧路径代码
- 心跳与广播改造：采用分片与微任务队列，避免长同步循环；严格采样日志
- 数据写策略：事务分片与重试逻辑需谨慎实现；保留 WAL 与索引稳定性

## 交付物
- 重构后的主进程代码（插件类型/依赖、连接池、心跳调度、SQLite/JSONL、速率限制）
- 不新增文档文件；仅在已有变更任务清单中标记完成项（若用户确认实施）